<!-- ====== วางแทนตั้งแต่ตรงนี้ ====== -->
<script>
/* ========= Read config, slug, etc. ========= */
function readCfg(){
  const TITLE = fTitle.value.trim();
  const SUBTITLE = fSub.value.trim();
  const LOGO_URL = fLogo.value.trim() || "https://img5.pic.in.th/file/secure-sv1/LOGO-Open-Sheets.jpg";
  const LINE_OA_ID = fLine.value.trim() || "@openshetts";
  const SHOP_URL = fShop.value.trim() || "";
  if(!TITLE) throw new Error("กรุณาใส่ 'ชื่อตำแหน่ง'");
  if(!SUBTITLE) throw new Error("กรุณาใส่ 'หน่วยงาน'");
  return {TITLE,SUBTITLE,LOGO_URL,LINE_OA_ID,SHOP_URL};
}
function slugify(str){
  if(!str) return "quiz";
  return str.trim()
    .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s\-_.]/g,"")
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-");
}

/* ========= Buttons ========= */
btnParse.addEventListener('click',()=>{
  try{
    const txt = fPlain.value.trim();
    if(!txt) throw new Error("กรุณาวางข้อความดิบก่อน");
    const arr = parsePlainToData(txt);
    if(arr.length===0) throw new Error("แปลงไม่พบข้อสอบ");
    fData.value = JSON.stringify(arr, null, 2);
    showOK(`แปลงสำเร็จ ✓ ข้อสอบ ${arr.length} ข้อ`);
  }catch(e){ showErr(e.message); }
});

btnValidate.addEventListener('click',()=>{
  try{
    const arr = JSON.parse(fData.value);
    if(!Array.isArray(arr) || arr.length===0) throw new Error("data ไม่ถูกต้องหรือว่าง");
    arr.forEach((x,i)=>{
      if(typeof x.q!=="string" || !x.q.trim()) throw new Error(`ข้อ ${i+1}: ไม่มีคำถาม (q)`);
      if(!Array.isArray(x.a) || x.a.length<2) throw new Error(`ข้อ ${i+1}: ต้องมีตัวเลือกอย่างน้อย 2 ข้อ`);
      if(typeof x.c!=="number" || x.c<0 || x.c>=x.a.length) throw new Error(`ข้อ ${i+1}: ตำแหน่งคำตอบ (c) ไม่ถูกต้อง`);
    });
    showOK(`ตรวจสอบผ่าน ✓ ${arr.length} ข้อ`);
  }catch(e){ showErr(e.message); }
});

btnGen.addEventListener('click',()=>{
  try{
    const cfg = readCfg();
    const arr = JSON.parse(fData.value);
    if(!Array.isArray(arr) || arr.length===0) throw new Error("data ว่างเปล่า");
    const html = buildQuizHTML(cfg, arr);
    const name = slugify(fFilename.value.trim() || `${cfg.TITLE}-${cfg.SUBTITLE}`) + ".html";
    const blob = new Blob([html], {type:"text/html;charset=utf-8"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
    showOK(`สร้างไฟล์สำเร็จ: ${name}`);
  }catch(e){ showErr(e.message); }
});

btnCfg.addEventListener('click',()=>{
  try{
    const cfg = readCfg();
    const arr = JSON.parse(fData.value||"[]");
    const out = {config:cfg, data:arr};
    const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (slugify(fFilename.value.trim() || `${cfg.TITLE}-${cfg.SUBTITLE}`) + ".config.json");
    a.click();
    URL.revokeObjectURL(a.href);
    showOK("ดาวน์โหลด config.json แล้ว");
  }catch(e){ showErr(e.message); }
});

btnClear.addEventListener('click',()=>{
  fPlain.value="";
  fData.value="";
  showOK("ล้างช่องกรอกแล้ว");
});
</script>
<!-- ====== จบส่วนที่ต้องแทนที่ ====== -->

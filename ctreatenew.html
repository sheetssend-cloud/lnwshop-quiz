<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ตัวตั้งค่า & ตัวสร้างไฟล์ HTML | Open Sheets</title>
<style>
  :root{--p:#005c97;--p2:#363795}
  *{box-sizing:border-box}
  html,body{margin:0}
  body{font-family:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:#f3f4f6;color:#222}
  .wrap{max-width:980px;margin:24px auto;background:#fff;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.08);overflow:hidden}
  header{background:linear-gradient(135deg,var(--p),var(--p2));color:#fff;padding:16px 20px}
  header h2{margin:0 0 4px 0;font-weight:800}
  .body{padding:18px 20px;display:grid;gap:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center}
  .row input,.row textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-family:inherit}
  .row textarea{min-height:220px}
  .muted{color:#6b7280;font-size:.92rem}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:#0d6efd;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.sec{background:#6c757d}
  .btn.ghost{background:#eef2f6;color:#0d6efd}
  .note{background:#f8fafc;border:1px dashed #cbd5e1;padding:12px;border-radius:12px}
  code.k{background:#f6f7f8;border:1px solid #e5e7eb;border-radius:6px;padding:.1rem .35rem}
  .ok{color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;padding:8px 10px;border-radius:10px;display:none}
  .err{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;padding:8px 10px;border-radius:10px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h2>ตัวตั้งค่า & ตัวสร้างไฟล์ HTML (แยกจากหน้าทดสอบ)</h2>
    <div class="muted">กรอกข้อมูล → วาง <code class="k">data</code> → กด “สร้างไฟล์ HTML” เพื่อดาวน์โหลดไฟล์ทดสอบสำหรับอัปขึ้นเว็บ</div>
  </header>

  <div class="body">
    <div class="grid">
      <div class="row">
        <label>ชื่อตำแหน่ง</label>
        <input id="fTitle" placeholder="เช่น ตำแหน่ง นักวิชาการพาณิชย์">
      </div>
      <div class="row">
        <label>หน่วยงาน</label>
        <input id="fSub" placeholder="เช่น กรมเจรจาการค้าระหว่างประเทศ">
      </div>
      <div class="row">
        <label>โลโก้ร้าน (URL)</label>
        <input id="fLogo" placeholder="https://.../logo.png">
      </div>
      <div class="row">
        <label>LINE OA (เช่น @openshetts)</label>
        <input id="fLine" placeholder="@yourline">
      </div>
      <div class="row">
        <label>ลิงก์หน้าร้าน/สินค้า</label>
        <input id="fShop" placeholder="https://www.opensheetsstore.com/....">
      </div>
      <div class="row">
        <label>ชื่อไฟล์ (ไม่ต้องใส่ .html)</label>
        <input id="fFilename" placeholder="เช่น นักวิชาการพาณิชย์-กรมเจรจาฯ">
      </div>
      <div class="row" style="grid-column:1/-1">
        <label>ข้อมูลข้อสอบ <span class="muted">(วางได้ทั้ง <code class="k">const data=[...]</code> หรือแค่อาร์เรย์)</span></label>
        <textarea id="fData" placeholder='ตัวอย่าง:
[
  {"q":"คำถาม 1?","a":["ก","ข","ค","ง"],"c":0,"ex":"อธิบาย"},
  {"q":"คำถาม 2?","a":["ก","ข","ค","ง"],"c":2}
]'></textarea>
      </div>
    </div>

    <div class="btns">
      <button id="btnSample" class="btn ghost">โหลดตัวอย่าง data</button>
      <button id="btnValidate" class="btn sec">ตรวจสอบรูปแบบ</button>
      <button id="btnGen" class="btn">สร้างไฟล์ HTML</button>
      <button id="btnCfg" class="btn ghost">ดาวน์โหลด config.json</button>
      <input type="file" id="fileImport" accept=".json,.txt" hidden>
      <button id="btnImport" class="btn ghost">นำเข้าจากไฟล์</button>
    </div>

    <div id="ok" class="ok">พร้อมใช้งาน ✅</div>
    <div id="err" class="err">พบข้อผิดพลาด</div>

    <div class="note">
      เคล็ดลัด: วางทั้งก้อนที่คัดลอกจากโค้ดเดิมแบบ <code class="k">const data = [ ... ]</code> ก็ได้ ระบบจะดึงเฉพาะอาร์เรย์ให้เอง
      <br>ไม่บังคับครบ 10 ข้อ / จำนวนตัวเลือก 2–6 ก็ได้ / <code class="k">ex</code> จะมีหรือไม่มีก็ได้
    </div>
  </div>
</div>

<script>
/* ===== ตัวอย่าง data (เปลี่ยนได้) ===== */
const SAMPLE_DATA = [
  {q:"ข้อใดคือหลักการที่สำคัญที่สุดขององค์การการค้าโลก (WTO) ที่ส่งเสริมการแข่งขันอย่างเป็นธรรม?",
   a:["หลักการไม่เลือกปฏิบัติ (Non-Discrimination)","หลักการค้าเสรี (Free Trade)","หลักการโปร่งใส (Transparency)","มาตรการปกป้อง (Safeguard)"], c:0, ex:"รวม MFN + National Treatment ให้แข่งขันเท่าเทียม"},
  {q:"ความตกลงใดของ WTO เกี่ยวกับทรัพย์สินทางปัญญา?", a:["GATT","GATS","TRIPS","TBT"], c:2, ex:"TRIPS = Trade-Related Aspects of IPR"},
  {q:"ข้อใดไม่ใช่เสาหลักของ AEC Blueprint?", a:["ตลาดและฐานการผลิตเดียว","เพิ่มขีดความสามารถการแข่งขัน","รวมกับเศรษฐกิจโลก","กองทุนการเงินอาเซียน"], c:3, ex:"AEC 2025 มี 4 เสา ไม่รวมกองทุน"},
  {q:"กฎว่าด้วยแหล่งกำเนิดสินค้า (Rules of Origin) สำคัญเพราะ?", a:["กำหนดภาษีแน่นอนทุกชนิด","ยืนยันว่าสินค้าที่ได้สิทธิเป็นของภาคีจริง","ควบคุม SPS","จำกัดโควตา"], c:1, ex:"กันสวมสิทธิ ต้องพิสูจน์สัญชาติสินค้า"},
  {q:'"Single Undertaking" หมายถึง?', a:["รับบางข้อตกลงได้","ต้องรับทั้งชุดหรือปฏิเสธทั้งชุด","เจรจาทีละหัวข้อ","พัฒนาได้ยกเว้นส่วนใหญ่"], c:1, ex:'“Nothing is agreed until everything is agreed.”'},
  {q:"หน่วยงานไทยที่ไต่สวน Anti-Dumping?", a:["กรมศุลกากร","กรมเจรจาการค้าระหว่างประเทศ","กรมการค้าต่างประเทศ","สคก.การแข่งขันทางการค้า"], c:2, ex:"DFT ดูแล AD/CVD/Safeguards"},
  {q:"ความต่างเด่น RCEP vs CPTPP?", a:["RCEP มาตรฐานแรงงานสูงกว่า","RCEP ริเริ่มโดยจีน, CPTPP โดยสหรัฐ","RCEP มีสมาชิก/ขนาดเศรษฐกิจรวมใหญ่กว่า","CPTPP เน้นสินค้า RCEP เน้นบริการ"], c:2, ex:"RCEP 15 ประเทศ ใหญ่สุดเมื่อวัด GDP+ประชากร"},
  {q:"BATNA คือ?", a:["ข้อเสนอที่อีกฝ่ายดีที่สุด","จุดยืนสุดท้าย","ทางเลือกดีที่สุดถ้าเจรจาล้มเหลว","ข้อตกลงเบื้องต้น"], c:2, ex:"BATNA แข็งแรง = อำนาจต่อรองสูง"},
  {q:"CBAM ระยะแรก EU กระทบสินค้ากลุ่มใดมาก?", a:["เกษตร/อาหาร","เหล็ก อะลูมิเนียม ปุ๋ย (ฯลฯ)","อิเล็กทรอนิกส์/ยานยนต์","สิ่งทอ"], c:1, ex:"กลุ่มปล่อยคาร์บอนสูง เช่น เหล็ก ปุ๋ย ซีเมนต์"},
  {q:"National Single Window (NSW) ของไทยคือ?", a:["พอร์ทัล BOI","ศูนย์กลางข้อมูลนำเข้า-ส่งออก/โลจิสติกส์จุดเดียว","คลังกฎหมายการค้า","แพลตฟอร์มเจรจาการค้ารัฐ"], c:1, ex:"ลดซ้ำซ้อน เอกสารผ่านช่องทางเดียว"}
];

/* ===== โครงหน้าแบบทดสอบที่ฝังลงในไฟล์ปลายทาง ===== */
function buildQuizHTML(cfg, dataArray){
  const esc = s=>String(s??"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  // ฝัง data เป็น JSON เพื่อลดปัญหา parse
  const dataJSON = JSON.stringify(dataArray, null, 2);
  const {TITLE,SUBTITLE,LOGO_URL,LINE_OA_ID,SHOP_URL} = cfg;

  return `<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${esc(TITLE)} | ร้านหนังสือ Open Sheets</title>
<style>
  :root{--p:#005c97;--p2:#363795;--ok:#198754;--bad:#dc3545;--muted:#6c757d;--text:#333}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:#f0f2f5}
  .wrap{max-width:800px;margin:18px auto;background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08);overflow:hidden}
  .header{background:linear-gradient(135deg,var(--p),var(--p2));color:#fff;padding:16px 20px;text-align:center}
  .brand{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .logo{height:42px;width:auto;object-fit:contain;border-radius:8px;background:#fff10;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
  h2{margin:4px 0 0}.sub{margin:4px 0 0;opacity:.95}.copyright{margin:8px 0 0;font-size:.95rem;opacity:.95}
  .body{padding:20px}
  .q{font-weight:700;line-height:1.6;margin-bottom:12px}
  .answers{display:grid;gap:10px}
  .opt{background:#f8f9fa;border:2px solid #ced4da;border-radius:10px;padding:12px 14px;text-align:left;cursor:pointer;transition:.18s}
  .opt:hover{background:#eef2f6;border-color:#0d6efd}
  .opt.correct{background:#d1e7dd;border-color:var(--ok);color:#0f5132;font-weight:700}
  .opt.wrong{background:#f8d7da;border-color:var(--bad);color:#842029}
  .ex{background:#f8f9fa;border-left:5px solid #6c757d;padding:12px 14px;margin-top:14px;display:none}
  .nav{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid #eee}
  .btn{background:#0d6efd;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn[disabled]{background:var(--muted);cursor:not-allowed}
  .score{font-size:2.4rem;font-weight:800;color:var(--p);margin:6px 0 14px}
  .result{text-align:center;display:none}
  .success{background:#28a745}
  .cta{margin:8px 0 16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn-line{background:#06c755}.btn-shop{background:#0d6efd}
  img,svg{pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="brand">
      <img id="logo" class="logo" alt="Open Sheets Logo">
      <div>
        <h2>${esc(TITLE)}</h2>
        <div class="sub">${esc(SUBTITLE)}</div>
        <div class="copyright">ร้านหนังสือ <b>Open Sheets</b> — จัดจำหน่ายหนังสือแนวข้อสอบ | LINE: <b>${esc(LINE_OA_ID)}</b></div>
      </div>
    </div>
  </div>

  <div class="body" id="panel">
    <div id="q" class="q">ข้อ 1. …</div>
    <div id="answers" class="answers"></div>
    <div id="ex" class="ex"><b>คำอธิบาย:</b> <span id="ex-text"></span></div>
    <div class="nav">
      <span id="progress">ข้อ 1 / 10</span>
      <button id="next" class="btn" disabled>ข้อต่อไป</button>
    </div>
  </div>

  <div class="body result" id="result">
    <h3>ผลการทดสอบ</h3>
    <div class="score" id="score">0 / 10</div>
    <p>หากสนใจสั่งซื้อไฟล์/เล่ม กดปุ่มด้านล่างได้เลย</p>
    <div class="cta">
      <a id="btnLine" class="btn btn-line" target="_blank" rel="noopener">สั่งซื้อทางไลน์</a>
      <a id="btnShop" class="btn btn-shop" target="_blank" rel="noopener">สั่งซื้อที่หน้าร้าน</a>
    </div>
    <button id="restart" class="btn success">ทำแบบทดสอบใหม่</button>
  </div>
</div>

<script>
const LOGO_URL   = ${JSON.stringify(LOGO_URL)};
const LINE_OA_ID = ${JSON.stringify(LINE_OA_ID)};
const SHOP_URL   = ${JSON.stringify(SHOP_URL)};
const data = ${dataJSON};

const q = document.getElementById('q');
const list = document.getElementById('answers');
const ex = document.getElementById('ex');
const exText = document.getElementById('ex-text');
const prog = document.getElementById('progress');
const next = document.getElementById('next');
const panel = document.getElementById('panel');
const result = document.getElementById('result');
const scoreEl = document.getElementById('score');
const restart = document.getElementById('restart');
const logo = document.getElementById('logo');
const btnLine = document.getElementById('btnLine');
const btnShop = document.getElementById('btnShop');

logo.src = LOGO_URL || "https://img5.pic.in.th/file/secure-sv1/LOGO-Open-Sheets.jpg";
const lineMsg = "https://line.me/R/ti/p/@304czfla?ts=02101411&oat_content=url" + location.href;
btnLine.href = 'https://line.me/R/ti/p/@304czfla?ts=02101411&oat_content=url' + encodeURIComponent(LINE_OA_ID) + '/?' + encodeURIComponent(lineMsg);
btnShop.href = SHOP_URL;

let i=0,score=0,locked=false;
const LETTERS = "กขคงจฉชซฌญฎฏฐฑฒณดตถทธนบปผพฝฟภมยรลวศษสหฬอฮ";

function render(){
  locked=false; next.disabled=true; ex.style.display="none"; list.innerHTML="";
  const item = data[i];
  q.textContent = \`ข้อ \${i+1}. \${item.q||""}\`;
  prog.textContent = \`ข้อ \${i+1} / \${data.length}\`;
  (item.a||[]).forEach((t,k)=>{
    const b=document.createElement('button');
    b.className='opt'; b.type='button';
    b.textContent = \`\${LETTERS[k]||"?"}. \${t}\`;
    b.onclick=()=>choose(k === Number(item.c));
    list.appendChild(b);
  });
  if(!item.a || item.a.length===0){
    const n=document.createElement('div'); n.style.color="#b02a37"; n.style.fontWeight="700";
    n.textContent="* ข้อนี้ยังไม่มีตัวเลือก"; list.appendChild(n);
  }
}
function choose(ok){
  if(locked) return; locked=true;
  [...list.children].forEach((b,idx)=>{
    if(!b.classList) return;
    b.disabled=true;
    b.classList.add(idx===Number(data[i].c) ? 'correct' : 'wrong');
  });
  if(ok) score++;
  exText.textContent = data[i].ex || "—";
  ex.style.display="block";
  next.textContent = (i===data.length-1) ? "ดูผลคะแนน" : "ข้อต่อไป";
  next.disabled=false;
}
function goNext(){ if(i < data.length-1){ i++; render(); } else { panel.style.display='none'; result.style.display='block'; scoreEl.textContent=\`\${score} / \${data.length}\`; } }
function reset(){ i=0; score=0; panel.style.display='block'; result.style.display='none'; render(); }

next.addEventListener('click',goNext);
restart.addEventListener('click',reset);
render();
</script>
</body>
</html>`;
}

/* ===== Helper ===== */
const $ = id => document.getElementById(id);
const fTitle = $('fTitle'), fSub=$('fSub'), fLogo=$('fLogo'), fLine=$('fLine'), fShop=$('fShop'), fFilename=$('fFilename'), fData=$('fData');
const okBox=$('ok'), errBox=$('err');
const btnSample=$('btnSample'), btnValidate=$('btnValidate'), btnGen=$('btnGen'), btnCfg=$('btnCfg');
const btnImport=$('btnImport'), fileImport=$('fileImport');

function showOK(msg){ okBox.textContent=msg||"พร้อมใช้งาน ✅"; okBox.style.display='block'; errBox.style.display='none'; }
function showErr(msg){ errBox.textContent=msg||"พบข้อผิดพลาด"; errBox.style.display='block'; okBox.style.display='none'; }

function extractArrayText(txt){
  if(!txt) return "";
  const m = txt.match(/\[\s*[\s\S]*\]/); // ดึงเฉพาะ [ ... ]
  return m ? m[0] : txt;
}
function parseData(txt){
  const s = extractArrayText(txt.trim());
  try{
    const arr = JSON.parse(s);
    if(Array.isArray(arr)) return arr;
  }catch(e){
    try{
      // รองรับ key ไม่ใส่ "" และ 'เดี่ยว'
      const fixed = s
        .replace(/(\W)q\s*:/g,'$1"q":')
        .replace(/(\W)a\s*:/g,'$1"a":')
        .replace(/(\W)c\s*:/g,'$1"c":')
        .replace(/(\W)ex\s*:/g,'$1"ex":')
        .replace(/'/g,'"');
      const arr2 = JSON.parse(fixed);
      if(Array.isArray(arr2)) return arr2;
    }catch(e2){
      throw new Error("รูปแบบ data ไม่ถูกต้อง (ลองตรวจ JSON อีกครั้ง)");
    }
  }
  throw new Error("ไม่พบอาร์เรย์ data ที่ถูกต้อง");
}
function slugify(str){
  if(!str) return "quiz";
  // อนุญาตอักษรไทย/อังกฤษ/เลข แปลงช่องว่างเป็นขีด
  return str.trim()
    .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s\-_.]/g,"")
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-");
}

function readCfg(){
  const TITLE = fTitle.value.trim();
  const SUBTITLE = fSub.value.trim();
  const LOGO_URL = fLogo.value.trim() || "https://img5.pic.in.th/file/secure-sv1/LOGO-Open-Sheets.jpg";
  const LINE_OA_ID = fLine.value.trim() || "@openshetts";
  const SHOP_URL = fShop.value.trim() || "";
  if(!TITLE) throw new Error("กรุณาใส่ 'ชื่อตำแหน่ง'");
  if(!SUBTITLE) throw new Error("กรุณาใส่ 'หน่วยงาน'");
  return {TITLE,SUBTITLE,LOGO_URL,LINE_OA_ID,SHOP_URL};
}

/* ===== Actions ===== */
btnSample.addEventListener('click',()=>{ fData.value = JSON.stringify(SAMPLE_DATA,null,2); showOK("โหลดตัวอย่างแล้ว"); });

btnValidate.addEventListener('click',()=>{
  try{
    const cfg = readCfg();
    const arr = parseData(fData.value);
    if(arr.length===0) throw new Error("data ว่างเปล่า");
    showOK(`ผ่านการตรวจสอบ ✓ ข้อสอบ ${arr.length} ข้อ`);
  }catch(err){ showErr(err.message); }
});

btnGen.addEventListener('click',()=>{
  try{
    const cfg = readCfg();
    const arr = parseData(fData.value);
    const html = buildQuizHTML(cfg, arr);
    const name = slugify(fFilename.value.trim() || `${cfg.TITLE}-${cfg.SUBTITLE}`) + ".html";
    const blob = new Blob([html], {type:"text/html;charset=utf-8"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
    showOK(`สร้างไฟล์สำเร็จ: ${name}`);
  }catch(err){ showErr(err.message); }
});

btnCfg.addEventListener('click',()=>{
  try{
    const cfg = readCfg();
    const arr = parseData(fData.value);
    const out = {config:cfg, data:arr};
    const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (slugify(fFilename.value.trim() || `${cfg.TITLE}-${cfg.SUBTITLE}`) + ".config.json");
    a.click();
    URL.revokeObjectURL(a.href);
    showOK("ดาวน์โหลด config.json แล้ว");
  }catch(err){ showErr(err.message); }
});

btnImport.addEventListener('click',()=>fileImport.click());
fileImport.addEventListener('change',async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    // รองรับไฟล์ config.json รูปแบบ {config:{}, data:[...]} หรือวาง data ตรง ๆ
    try{
      const obj = JSON.parse(text);
      if(obj && obj.config && obj.data){
        const {TITLE,SUBTITLE,LOGO_URL,LINE_OA_ID,SHOP_URL} = obj.config;
        fTitle.value = TITLE||""; fSub.value = SUBTITLE||"";
        fLogo.value = LOGO_URL||""; fLine.value = LINE_OA_ID||""; fShop.value = SHOP_URL||"";
        fData.value = JSON.stringify(obj.data,null,2);
        showOK("นำเข้า config.json สำเร็จ");
        return;
      }
    }catch(_){} // ถ้าไม่ใช่รูปแบบ config ก็จะลองยัดเป็น data ตรง ๆ
    fData.value = text;
    showOK("นำเข้าข้อมูลไฟล์ข้อความเรียบร้อย");
  }catch(err){ showErr("ไม่สามารถอ่านไฟล์ได้"); }
});
</script>
</body>
</html>

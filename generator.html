<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ตัวสร้างโค้ดกล่องทดลองสอบ — ไม่มีข้อแม้</title>
<style>
  body{font-family:"Sarabun",system-ui,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;margin:0;background:#f6f7fb}
  .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
  h1{margin:8px 0 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
  label{font-weight:700;display:block;margin-bottom:6px}
  input,textarea{width:100%;box-sizing:border-box;border:1px solid #d6d9df;border-radius:8px;padding:10px;font-size:14px}
  textarea{min-height:240px;font-family:ui-monospace,Consolas,monospace}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:#0d6efd;color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.g{background:#198754}.btn.gray{background:#6c757d}
  #out{min-height:520px}
  .hint{font-size:12px;color:#555}
</style>
</head>
<body>
<div class="wrap">
  <h1>ตัวสร้างโค้ดกล่องทดลองสอบ — Open Sheets</h1>
  <div class="grid">
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>หัวข้อใหญ่ (เว้นได้)</label>
          <input id="title" placeholder="แบบทดลองสอบ">
        </div>
        <div style="flex:1">
          <label>หน่วยงาน/คำอธิบายย่อย (เว้นได้)</label>
          <input id="subtitle" placeholder="กรมเจรจาการค้าระหว่างประเทศ">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>โลโก้ร้าน (URL .png/.jpg เว้นได้)</label>
          <input id="logo" placeholder="">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>LINE OA ID (เว้นได้)</label>
          <input id="line" placeholder="@openshetts">
        </div>
        <div style="flex:1">
          <label>ลิงก์หน้าร้าน/หน้าสินค้า (เว้นได้)</label>
          <input id="shop" placeholder="https://www.yourshop.example">
        </div>
      </div>
      <div style="margin-top:14px">
        <label>วางแนวข้อสอบ (รูปแบบไทย — ใส่กี่ข้อก็ได้)</label>
        <textarea id="src" placeholder="ตัวอย่าง:&#10;ข้อ 1. คำถาม...&#10;ก) ตัวเลือก1&#10;ข) ตัวเลือก2&#10;ค) ตัวเลือก3&#10;ง) ตัวเลือก4&#10;คำตอบ : ก&#10;คำอธิบาย : ใส่อธิบาย..."></textarea>
        <div class="hint">รองรับ: ข้อ 1./2./… • ช้อยส์ ก)/ข)/ค)/ง) • คำตอบ : (ก/ข/ค/ง หรือ 1–4) • คำอธิบาย : (ไม่ใส่ก็ได้)</div>
      </div>
      <div style="margin-top:12px" class="row">
        <button class="btn" onclick="generate()">Generate โค้ด</button>
        <button class="btn g" onclick="downloadOut()">ดาวน์โหลด (quiz.html)</button>
        <button class="btn gray" onclick="previewOut()">แสดงตัวอย่าง</button>
      </div>
    </div>

    <div class="card">
      <label>ผลลัพธ์ (quiz.html)</label>
      <textarea id="out"></textarea>
      <div class="hint" style="margin-top:6px">คัดลอกทั้งหมดเป็นไฟล์ <b>quiz.html</b> หรือกดดาวน์โหลด → อัปขึ้นโฮสต์ (GitHub Pages/Netlify) แล้วฝัง iFrame ใน LnwShop</div>
    </div>
  </div>
</div>

<script>
/* ================== TEMPLATE (กล่องสอบสมบูรณ์) ================== */
const TEMPLATE = `<!doctype html>
<html lang="th"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>__TITLE__ | Open Sheets</title>
<style>
  html,body{margin:0;background:#f0f2f5;font-family:"Sarabun",system-ui,Segoe UI,Roboto,"Noto Sans Thai",sans-serif}
  #lnwq-box{--p:#005c97;--p2:#363795;--ok:#198754;--bad:#dc3545;--mut:#6c757d;--text:#333;color:var(--text)}
  .c{background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:800px;margin:16px auto;overflow:hidden}
  .h{background:linear-gradient(135deg,var(--p),var(--p2));color:#fff;padding:18px 22px;text-align:center;position:relative}
  .t{margin:0;font-size:1.35rem}
  .s{margin:.25rem 0 0;opacity:.95}
  .brand{margin:.35rem 0 0;opacity:.95;font-size:.95rem}
  .logo{position:absolute;left:14px;top:14px;height:42px;width:auto;border-radius:8px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);padding:4px;object-fit:contain}
  .b{padding:22px}
  .q{font-weight:700;line-height:1.6;font-size:1.05rem;margin:0 0 16px}
  .ans{display:grid;gap:10px}
  .opt{background:#f8f9fa;border:2px solid #ced4da;border-radius:10px;padding:12px 14px;text-align:left;cursor:pointer;transition:.18s}
  .opt:hover:not([disabled]){background:#eef2f6;border-color:#0d6efd}
  .ok{background:#d1e7dd;border-color:var(--ok);color:#0f5132;font-weight:700}
  .bad{background:#f8d7da;border-color:#dc3545;color:#842029}
  .opt:disabled{opacity:.9;cursor:not-allowed}
  .ex{background:#f8f9fa;border-left:5px solid #6c757d;padding:12px 14px;margin-top:14px;font-size:.98rem}
  .nav{display:flex;justify-content:space-between;align-items:center;margin-top:18px;padding-top:14px;border-top:1px solid #eee}
  .btn{background:#0d6efd;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer}
  .btn:disabled{background:#6c757d;cursor:not-allowed}
  .result h3{font-size:1.6rem;margin:0 0 6px}
  .score{font-size:2.6rem;font-weight:800;color:#005c97;margin:6px 0 14px}
</style>
<body>
<div id="lnwq-box">
  <div class="c">
    <div class="h">
      <img class="logo" id="logo" alt="Logo" src="__LOGO__">
      <h2 class="t">__TITLE__</h2>
      <p class="s">__SUBTITLE__</p>
      <p class="brand">ร้านหนังสือ <b>Open Sheets</b> | LINE: <b>__LINEOA__</b></p>
    </div>
    <div class="b">
      <div id="qa">
        <p id="qt" class="q"></p>
        <div id="aw" class="ans"></div>
        <div id="ex" class="ex" hidden><strong>คำอธิบาย:</strong> <span id="ex-t"></span></div>
        <div class="nav"><span id="prog"></span><button id="next" class="btn" disabled>ข้อต่อไป</button></div>
      </div>
      <div id="rs" class="result" hidden>
        <h3>ผลการทดสอบ</h3>
        <p>คุณทำได้</p>
        <div id="score" class="score"></div>
        <button id="restart" class="btn">ทำแบบทดสอบใหม่</button>
      </div>
    </div>
  </div>
</div>
<script>
const LOGO="__LOGO__", TITLE="__TITLE__", SUB="__SUBTITLE__", LINEOA="__LINEOA__", SHOP="__SHOP__", DATA=__DATA__;
(function(){
  const L=document.getElementById('logo'); if(!LOGO) L.style.display='none'; else L.src=LOGO;
  document.title = (TITLE||'แบบทดลองสอบ')+' | Open Sheets';
  const qt=document.getElementById('qt'), aw=document.getElementById('aw'), prog=document.getElementById('prog');
  const ex=document.getElementById('ex'), ext=document.getElementById('ex-t'), next=document.getElementById('next');
  const qa=document.getElementById('qa'), rs=document.getElementById('rs'), score=document.getElementById('score');
  let i=0, sc=0, locked=false, d=Array.isArray(DATA)&&DATA.length?DATA:[{q:'ตัวอย่างคำถาม',a:[{t:'ตัวเลือก ก',ok:true},{t:'ตัวเลือก ข'},{t:'ตัวเลือก ค'},{t:'ตัวเลือก ง'}],ex:''}];
  function render(){
    locked=false; next.disabled=true; ex.hidden=true; aw.innerHTML='';
    const it=d[i]; qt.textContent='ข้อ '+(i+1)+'. '+(it.q||''); prog.textContent='ข้อ '+(i+1)+' / '+d.length;
    it.a.forEach((o,k)=>{const b=document.createElement('button'); b.className='opt'; b.textContent=('กขคง'[k]||'')+'. '+(o.t||''); b.onclick=()=>choose(o.ok,b); aw.appendChild(b);});
  }
  function choose(ok,btn){
    if(locked) return; locked=true;
    [...aw.children].forEach((b,j)=>{ b.disabled=true; b.classList.add(d[i].a[j].ok?'ok':'bad'); });
    if(ok) sc++; ext.textContent=d[i].ex||''; ex.hidden=!ext.textContent;
    next.textContent=(i===d.length-1)?'ดูผลคะแนน':'ข้อต่อไป'; next.disabled=false;
  }
  next.onclick=()=>{ if(i<d.length-1){i++; next.textContent='ข้อต่อไป'; render();} else {qa.hidden=true; rs.hidden=false; score.textContent=sc+' / '+d.length;} };
  document.getElementById('restart').onclick=()=>{i=0; sc=0; locked=false; qa.hidden=false; rs.hidden=true; next.textContent='ข้อต่อไป'; render();};
  render();
})();
</script>
</body></html>`;

/* ================== PARSER: ยืดหยุ่น/ไม่บังคับอะไร ================== */
function parseFlexible(txt){
  const lines = (txt||'').replace(/\r/g,'').split('\n');
  const map = {'ก':0,'ข':1,'ค':2,'ง':3};
  let cur=null, opts=['','','',''], ex=[];
  const items=[];
  function push(){
    if(!cur){return;}
    // เติมช้อยส์ให้ครบ 4
    for(let i=0;i<4;i++){ if(!opts[i]) opts[i]=''; }
    // ถ้าไม่มีคำตอบ → ใช้ข้อ ก เป็นคำตอบ
    if(cur.ans==null) cur.ans=0;
    items.push({
      q: (cur.q||'').trim(),
      a: opts.map((t,i)=>({t: (t||'').trim(), ok: i===cur.ans})),
      ex: ex.join(' ').trim()
    });
    cur=null; opts=['','','','']; ex=[];
  }
  for(const raw of lines){
    const L = raw.trim(); if(!L) continue;
    const qm = L.match(/^ข้อ\s*\d+[\.\:\-：]\s*(.*)$/);
    if(qm){ push(); cur={q:qm[1], ans:null}; continue; }
    const om = L.match(/^([กขคง])[)\.\:\-]\s*(.*)$/);
    if(om){ if(!cur) cur={q:'',ans:null}; const idx=map[om[1]]; opts[idx]=om[2]; continue; }
    const am = L.match(/^คำตอบ\s*[:：]\s*([กขคง1234])$/);
    if(am){ if(!cur) cur={q:'',ans:null}; const v=am[1]; cur.ans = /[1234]/.test(v)?(parseInt(v,10)-1):map[v]; continue; }
    const exm = L.match(/^คำอธิบาย\s*[:：]\s*(.*)$/);
    if(exm){ if(!cur) cur={q:'',ans:null}; ex.push(exm[1]); continue; }
    if(cur) ex.push(L);
  }
  push();
  // ถ้าไม่เจออะไรเลย → ใส่ตัวอย่าง 1 ข้อ
  if(items.length===0){
    items.push({
      q:'ตัวอย่างคำถาม',
      a:[{t:'ตัวเลือก ก',ok:true},{t:'ตัวเลือก ข'},{t:'ตัวเลือก ค'},{t:'ตัวเลือก ง'}],
      ex:''
    });
  }
  return items;
}

/* ================== GENERATE / DOWNLOAD / PREVIEW ================== */
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function generate(){
  const title=document.getElementById('title').value||'แบบทดลองสอบ';
  const subtitle=document.getElementById('subtitle').value||'';
  const logo=document.getElementById('logo').value||'';
  const line=document.getElementById('line').value||'';
  const shop=document.getElementById('shop').value||'';
  const data=parseFlexible(document.getElementById('src').value);

  const html=TEMPLATE
    .replaceAll('__TITLE__', esc(title))
    .replaceAll('__SUBTITLE__', esc(subtitle))
    .replaceAll('__LOGO__', logo)
    .replaceAll('__LINEOA__', esc(line))
    .replaceAll('__SHOP__', shop)
    .replace('__DATA__', JSON.stringify(data));

  document.getElementById('out').value = html;
}
function downloadOut(){
  const txt=document.getElementById('out').value.trim(); if(!txt){generate();}
  const blob=new Blob([document.getElementById('out').value],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz.html';
  document.body.appendChild(a); a.click(); a.remove();
}
function previewOut(){
  if(!document.getElementById('out').value.trim()) generate();
  const blob=new Blob([document.getElementById('out').value],{type:'text/html;charset=utf-8'});
  const url=URL.createObjectURL(blob); window.open(url,'_blank');
}
</script>
</body>
</html>
